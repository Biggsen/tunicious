<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session b0b83fa7-919e-4dde-b8b7-75c51ff6b0a3 (2025-11-02 10:58Z) -->

# Spotify integration refresh token issue (2025-11-02 10:58Z)

_**User (2025-11-02 07:09Z)**_

the spotify integration still expires after 1 hour. are we using the refresh token?

---

_**Agent (model default, mode Ask)**_



---


Checking the Spotify integration for refresh token usage.


---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "How is Spotify authentication token refresh handled?" • **11** results</summary>
            
| File | Lines |
|------|-------|
| `src/composables/useUserSpotifyApi.js` | L4-601 |
| `functions/src/spotify.js` | L81-147 |
| `src/composables/useSpotifyApi.js` | L231 |
| `src/utils/auth.js` | L60 |
| `functions/src/spotify.js` | L14-147 |
| `src/composables/useBackendApi.js` | L3-110 |
| `src/composables/useUserSpotifyApi.js` | L601 |
| `src/composables/useBackendApi.js` | L110 |
| `functions/src/spotify.js` | L81-196 |
| `src/views/auth/SpotifyCallbackView.vue` | L74 |
| `functions/src/spotify.js` | L77 |

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "Where are Spotify access tokens stored and how are they refreshed?" • **12** results</summary>
            
| File | Lines |
|------|-------|
| `src/composables/useUserSpotifyApi.js` | L4-601 |
| `src/composables/useSpotifyApi.js` | L231 |
| `src/utils/auth.js` | L60 |
| `functions/src/spotify.js` | L81-147 |
| `src/views/auth/SpotifyCallbackView.vue` | L74 |
| `src/composables/useUserSpotifyApi.js` | L601 |
| `src/composables/useBackendApi.js` | L3-110 |
| `functions/src/spotify.js` | L14-147 |
| `src/composables/useBackendApi.js` | L110 |
| `functions/src/spotify.js` | L77 |
| `tasks/security-remediation-spec.md` | L63 |
| `functions/src/spotify.js` | L81-196 |

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "refresh.*token|refreshToken" • 52 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `.\src\composables\useUserSpotifyApi.js` | `const \{ refreshSpotifyToken, spotifyApiCall \} = useBackendApi();` | L11 |
| `.\src\composables\useUserSpotifyApi.js` | `* Refreshes the user's Spotify access token` | L41 |
| `.\src\composables\useUserSpotifyApi.js` | `const refreshUserToken = async () => \{` | L43 |
| `.\src\composables\useUserSpotifyApi.js` | `if (!userData.spotifyTokens \|\| !userData.spotifyTokens.refreshToken) \{` | L56 |
| `.\src\composables\useUserSpotifyApi.js` | `throw new Error('Spotify not connected or missing refresh token');` | L57 |
| `.\src\composables\useUserSpotifyApi.js` | `const result = await refreshSpotifyToken(userData.spotifyTokens.refreshToken);` | L61 |
| `.\src\composables\useUserSpotifyApi.js` | `refreshToken: result.refreshToken \|\| userData.spotifyTokens.refreshToken, // Keep old refresh token if not provided` | L67 |
| `.\src\composables\useUserSpotifyApi.js` | `// Check if this is a refresh token expiration error` | L78 |
| `.\src\composables\useUserSpotifyApi.js` | `if (err.message.includes('Failed to refresh token') \|\| err.message.includes('400')) \{` | L79 |
| `.\src\composables\useUserSpotifyApi.js` | `throw new Error('Spotify refresh token expired - please reconnect your account');` | L87 |
| `.\src\composables\useUserSpotifyApi.js` | `* Proactively refresh token if it's close to expiration (within 10 minutes)` | L95 |
| `.\src\composables\useUserSpotifyApi.js` | `if (!userData.spotifyTokens \|\| !userData.spotifyTokens.refreshToken) \{` | L109 |
| `.\src\composables\useUserSpotifyApi.js` | `return await refreshUserToken();` | L119 |
| `.\src\composables\useUserSpotifyApi.js` | `if (!userData.spotifyTokens.refreshToken) \{` | L148 |
| `.\src\composables\useUserSpotifyApi.js` | `return \{ connected: false, error: 'No refresh token available' \};` | L149 |
| `.\src\composables\useUserSpotifyApi.js` | `await refreshUserToken();` | L156 |
| `.\src\composables\useUserSpotifyApi.js` | `// If API call fails, try refreshing the token` | L171 |
| `.\src\composables\useUserSpotifyApi.js` | `await refreshUserToken();` | L174 |
| `.\src\composables\useUserSpotifyApi.js` | `// Try to refresh token if expired or about to expire` | L205 |
| `.\src\composables\useUserSpotifyApi.js` | `accessToken = await refreshUserToken();` | L209 |
| `.\src\composables\useUserSpotifyApi.js` | `// If refresh fails, clear the tokens and ask user to reconnect` | L214 |
| `.\src\composables\useUserSpotifyApi.js` | `if (err.message.includes('Failed to refresh token') \|\| err.message.includes('400')) \{` | L238 |
| `.\src\composables\useUserSpotifyApi.js` | `refreshUserToken,` | L590 |
| `.\src\composables\useBackendApi.js` | `if (errorMessage.includes('refresh token')) \{` | L36 |
| `.\src\composables\useBackendApi.js` | `errorMessage = 'Spotify refresh token expired - please reconnect your account';` | L37 |
| `.\src\composables\useBackendApi.js` | `* Refresh Spotify access token` | L77 |
| `.\src\composables\useBackendApi.js` | `const refreshSpotifyToken = async (refreshToken) => \{` | L79 |
| `.\src\composables\useBackendApi.js` | `return makeRequest('spotifyRefreshToken', \{` | L80 |
| `.\src\composables\useBackendApi.js` | `body: \{ refreshToken \},` | L81 |
| `.\src\composables\useBackendApi.js` | `refreshSpotifyToken,` | L107 |
| `.\functions\src\spotify.js` | `refreshToken: tokenData.refresh_token,` | L70 |
| `.\functions\src\spotify.js` | `* Refresh access token using refresh token` | L81 |
| `.\functions\src\spotify.js` | `exports.refreshToken = onRequest(\{` | L83 |
| `.\functions\src\spotify.js` | `const \{refreshToken\} = req.body;` | L93 |
| `.\functions\src\spotify.js` | `if (!refreshToken) \{` | L95 |
| `.\functions\src\spotify.js` | `res.status(400).json(\{error: "Missing refresh token"\});` | L96 |
| `.\functions\src\spotify.js` | `grant_type: "refresh_token",` | L115 |
| `.\functions\src\spotify.js` | `refresh_token: refreshToken,` | L116 |
| `.\functions\src\spotify.js` | `logger.error("Spotify token refresh failed", \{status: tokenResponse.status, error: errorData\});` | L123 |
| `.\functions\src\spotify.js` | `let errorMessage = "Failed to refresh token";` | L126 |
| `.\functions\src\spotify.js` | `errorMessage = "Refresh token expired or invalid - please reconnect your Spotify account";` | L128 |
| `.\src\composables\useSpotifyApi.js` | `await refreshToken();` | L15 |
| `.\src\composables\useSpotifyApi.js` | `* Refreshes the Spotify access token` | L21 |
| `.\src\composables\useSpotifyApi.js` | `const refreshToken = async () => \{` | L23 |
| `.\src\composables\useSpotifyApi.js` | `throw new Error(`Failed to refresh token: $\{response.status\}`);` | L40 |
| `.\src\composables\useSpotifyApi.js` | `refreshToken,` | L221 |
| `.\src\views\auth\SpotifyCallbackView.vue` | `refreshToken: tokens.refreshToken,` | L34 |
| `.\functions\index.js` | `exports.spotifyRefreshToken = spotifyFunctions.refreshToken;` | L27 |
| `.\tasks\security-remediation-spec.md` | `Response: \{ accessToken: string, refreshToken: string, expiresIn: number \}` | L36 |
| `.\tasks\security-remediation-spec.md` | `POST /api/spotify/refresh-token` | L41 |
| `.\tasks\security-remediation-spec.md` | `Body: \{ refreshToken: string \}` | L42 |
| `.\src\utils\auth.js` | `const newToken = await spotifyApi.refreshToken();` | L24 |


</details>
</tool-use>

---



---

Checking where user tokens are used and whether expiration is checked:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/composables/useUserSpotifyApi.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/composables/useBackendApi.js</summary>

</details>
</tool-use>

---



---

The refresh token infrastructure exists, but there may be an issue with how it's invoked. Checking where `makeUserRequest` is called to see if tokens are being checked before expiration:


---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "makeUserRequest|getUserTokens|ensureTokenFresh" • 27 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `.\src\composables\useUserSpotifyApi.js` | `const getUserTokens = async () => \{` | L16 |
| `.\src\composables\useUserSpotifyApi.js` | `const ensureTokenFresh = async () => \{` | L97 |
| `.\src\composables\useUserSpotifyApi.js` | `console.error('Error in ensureTokenFresh:', err);` | L124 |
| `.\src\composables\useUserSpotifyApi.js` | `await makeUserRequest('/me');` | L166 |
| `.\src\composables\useUserSpotifyApi.js` | `const makeUserRequest = async (endpoint, options = \{}) => \{` | L192 |
| `.\src\composables\useUserSpotifyApi.js` | `const tokens = await getUserTokens();` | L199 |
| `.\src\composables\useUserSpotifyApi.js` | `const profile = await makeUserRequest('https://api.spotify.com/v1/me');` | L261 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(`https://api.spotify.com/v1/users/$\{profile.id\}/playlists`, \{` | L274 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(`https://api.spotify.com/v1/playlists/$\{playlistId\}/tracks`, \{` | L284 |
| `.\src\composables\useUserSpotifyApi.js` | `const albumTracks = await makeUserRequest(`https://api.spotify.com/v1/albums/$\{albumId\}/tracks?limit=50`);` | L297 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(`https://api.spotify.com/v1/me/playlists?limit=$\{limit\}&offset=$\{offset\}`);` | L310 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(`https://api.spotify.com/v1/playlists/$\{playlistId\}`);` | L317 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(`https://api.spotify.com/v1/playlists/$\{playlistId\}`, \{` | L324 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(`https://api.spotify.com/v1/playlists/$\{playlistId\}/tracks?limit=$\{limit\}&offset=$\{offset\}`);` | L334 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(`https://api.spotify.com/v1/playlists/$\{playlistId\}/tracks`, \{` | L431 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(`https://api.spotify.com/v1/search?q=$\{encodedQuery\}&type=album&limit=$\{limit\}`);` | L442 |
| `.\src\composables\useUserSpotifyApi.js` | `const data = await makeUserRequest(` | L464 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(` | L493 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(`https://api.spotify.com/v1/albums/$\{albumId\}`);` | L520 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(` | L527 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(` | L536 |
| `.\src\composables\useUserSpotifyApi.js` | `return makeUserRequest(`https://api.spotify.com/v1/artists/$\{artistId\}`);` | L569 |
| `.\src\composables\useUserSpotifyApi.js` | `makeUserRequest,` | L575 |
| `.\src\composables\useUserSpotifyApi.js` | `getUserTokens,` | L589 |
| `.\src\composables\useUserSpotifyApi.js` | `ensureTokenFresh,` | L591 |
| `.\src\components\SpotifyDiagnostic.vue` | `const \{ getUserTokens, makeUserRequest \} = useUserSpotifyApi();` | L10 |
| `.\src\components\SpotifyDiagnostic.vue` | `await makeUserRequest('/me');` | L88 |


</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: functions/src/spotify.js</summary>

</details>
</tool-use>

---



---

The refresh token logic exists, but there's a potential issue. In `getUserTokens()` at ```31:34:src/composables/useUserSpotifyApi.js```, it throws an error if the token expires within 5 minutes, which triggers a refresh in `makeUserRequest()`. However, I notice that:

1. **The refresh endpoint is working correctly** — `refreshUserToken()` uses the refresh token properly.

2. **The problem might be in the expiration check logic** — `getUserTokens()` throws if `expiresAt < (Date.now() + bufferTime)`, which means it throws when the token expires within 5 minutes. This should work, but if the refresh token itself has expired, the refresh will fail.

3. **The `ensureTokenFresh()` function isn't being called automatically** — This function proactively refreshes tokens within 10 minutes of expiration, but it doesn't appear to be called on app load or periodically.

The issue is likely that:
- The token expires after 1 hour
- When API calls happen after expiration, `getUserTokens()` throws
- The refresh attempt happens, but either:
  - The refresh token has also expired/invalid
  - There's a timing issue where the token expires before the refresh completes

To fix this, you should:

1. **Call `ensureTokenFresh()` proactively** when the app loads or when making API calls
2. **Verify the refresh token is still valid** — check if it's expired in Firestore

The refresh token mechanism is implemented, but it may not be triggered early enough, or the refresh token may have expired. Check the browser console for refresh errors when tokens expire.

---

_**User (2025-11-02 07:09Z)**_

fix it

---

_**Agent (model default, mode Agent)**_



---


Fixing token refresh by making it proactive. Reviewing the code and applying the fix:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/composables/useUserSpotifyApi.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "Where is ensureTokenFresh called or used?" • **11** results</summary>
            
| File | Lines |
|------|-------|
| `src/composables/useUserSpotifyApi.js` | L4-601 |
| `src/composables/useSpotifyApi.js` | L231 |
| `src/utils/auth.js` | L60 |
| `src/composables/useUserSpotifyApi.js` | L601 |
| `src/composables/useBackendApi.js` | L3-110 |
| `src/components/SpotifyDiagnostic.vue` | L60-106 |
| `src/components/SpotifyDiagnostic.vue` | L63 |
| `src/composables/useBackendApi.js` | L110 |
| `src/views/auth/SpotifyCallbackView.vue` | L74 |
| `tasks/security-remediation-spec.md` | L63 |
| `src/views/auth/LastFmCallbackView.vue` | L69 |

</details>
</tool-use>

---



---

Modifying `makeUserRequest` to proactively refresh the token before use:


---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/composables/useUserSpotifyApi.js</summary>

**Chunk 1**
Lines added: 39, lines removed: 32

```diff
@@ -195,36 +195,43 @@
        error.value = null;
  
-       let accessToken;
-       try {
-         const tokens = await getUserTokens();
-         accessToken = tokens.accessToken;
-         console.log('Using existing token, expires at:', new Date(tokens.expiresAt));
-       } catch (err) {
-         console.log('Token error:', err.message);
-         
-         // Try to refresh token if expired or about to expire
-         if (err.message.includes('expired') || err.message.includes('reconnect')) {
-           console.log('Attempting token refresh...');
-           try {
-             accessToken = await refreshUserToken();
-             console.log('Token refreshed successfully');
-           } catch (refreshErr) {
-             console.error('Token refresh failed:', refreshErr.message);
-             
-             // If refresh fails, clear the tokens and ask user to reconnect
-             if (refreshErr.message.includes('reconnect') || refreshErr.message.includes('expired')) {
-               // Clear the invalid tokens from Firestore
-               await setDoc(doc(db, 'users', user.value.uid), {
-                 spotifyTokens: null,
-                 spotifyConnected: false,
-                 updatedAt: serverTimestamp()
-               }, { merge: true });
-               throw new Error('Spotify connection lost - please reconnect your account');
-             }
-             throw refreshErr;
-           }
-         } else {
-           throw err;
-         }
+       // Proactively ensure token is fresh before making any request
+       let accessToken = await ensureTokenFresh();
+       
+       // If ensureTokenFresh returned null, try to get tokens directly
+       if (!accessToken) {
+         try {
+           const tokens = await getUserTokens();
+           accessToken = tokens.accessToken;
+           console.log('Using existing token, expires at:', new Date(tokens.expiresAt));
+         } catch (err) {
+           console.log('Token error:', err.message);
+           
+           // Try to refresh token if expired or about to expire
+           if (err.message.includes('expired') || err.message.includes('reconnect')) {
+             console.log('Attempting token refresh...');
+             try {
+               accessToken = await refreshUserToken();
+               console.log('Token refreshed successfully');
+             } catch (refreshErr) {
+               console.error('Token refresh failed:', refreshErr.message);
+               
+               // If refresh fails, clear the tokens and ask user to reconnect
+               if (refreshErr.message.includes('reconnect') || refreshErr.message.includes('expired')) {
+                 // Clear the invalid tokens from Firestore
+                 await setDoc(doc(db, 'users', user.value.uid), {
+                   spotifyTokens: null,
+                   spotifyConnected: false,
+                   updatedAt: serverTimestamp()
+                 }, { merge: true });
+                 throw new Error('Spotify connection lost - please reconnect your account');
+               }
+               throw refreshErr;
+             }
+           } else {
+             throw err;
+           }
+         }
+       } else {
+         console.log('Token was proactively refreshed, using fresh token');
        }
  
```

</details>

</tool-use>

---



---

Updating `getUserTokens()` to handle expiration better and check whether the refresh token response should include a refreshToken:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/composables/useUserSpotifyApi.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: functions/src/spotify.js</summary>

</details>
</tool-use>

---



---

Updating the backend to return the refresh token if Spotify provides one:


---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: functions/src/spotify.js</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -139,4 +139,5 @@
      res.json({
        accessToken: tokenData.access_token,
+       refreshToken: tokenData.refresh_token, // Spotify may optionally return a new refresh token
        expiresIn: tokenData.expires_in,
        tokenType: tokenData.token_type,
```

</details>

</tool-use>

---



---

Updating `getUserTokens()` to handle expiration more gracefully since we now refresh proactively:


---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/composables/useUserSpotifyApi.js</summary>

**Chunk 1**
Lines added: 9, lines removed: 3

```diff
@@ -29,7 +29,13 @@
      }
  
-     // Check if token is expired (with 5 minute buffer to refresh proactively)
-     const bufferTime = 5 * 60 * 1000; // 5 minutes
-     if (userData.spotifyTokens.expiresAt &lt; (Date.now() + bufferTime)) {
+     // Check if token is expired or about to expire
+     // Note: ensureTokenFresh() is called proactively in makeUserRequest,
+     // but this check is still useful for other callers
+     const now = Date.now();
+     const expiresAt = typeof userData.spotifyTokens.expiresAt === 'number' 
+       ? userData.spotifyTokens.expiresAt 
+       : userData.spotifyTokens.expiresAt?.toMillis?.() || userData.spotifyTokens.expiresAt;
+     
+     if (!expiresAt || expiresAt &lt;= now) {
        throw new Error('Spotify token expired - please reconnect');
      }
```

</details>

</tool-use>

---



---

Updating `ensureTokenFresh()` to handle Firestore timestamp types correctly:


---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/composables/useUserSpotifyApi.js</summary>

**Chunk 1**
Lines added: 15, lines removed: 2

```diff
@@ -116,11 +116,24 @@
          return null;
        }
+ 
+       // Handle Firestore timestamp types correctly
+       const now = Date.now();
+       const expiresAt = typeof userData.spotifyTokens.expiresAt === 'number' 
+         ? userData.spotifyTokens.expiresAt 
+         : userData.spotifyTokens.expiresAt?.toMillis?.() || userData.spotifyTokens.expiresAt;
+       
+       if (!expiresAt) {
+         return null;
+       }
  
        // Check if token expires within 10 minutes
        const tenMinutes = 10 * 60 * 1000;
-       const timeUntilExpiry = userData.spotifyTokens.expiresAt - Date.now();
+       const timeUntilExpiry = expiresAt - now;
        
        if (timeUntilExpiry &lt; tenMinutes) {
-         console.log('Token expires soon, refreshing proactively...');
+         console.log('Token expires soon, refreshing proactively...', {
+           expiresAt: new Date(expiresAt),
+           timeUntilExpiry: Math.round(timeUntilExpiry / 1000 / 60) + ' minutes'
+         });
          return await refreshUserToken();
        }
```

</details>

</tool-use>

---



---

Updating `checkConnectionStatus` to handle timestamps correctly:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/composables/useUserSpotifyApi.js</summary>

</details>
</tool-use>

---



---

Fixing `checkConnectionStatus` to handle timestamps correctly:


---

<tool-use data-tool-type="write" data-tool-name="search_replace">

<details><summary>Tool use: **search_replace** • Edit file: src/composables/useUserSpotifyApi.js</summary>

**Chunk 1**
Lines added: 7, lines removed: 2

```diff
@@ -169,6 +169,11 @@
        }
  
-       // Check if token is expired
-       if (userData.spotifyTokens.expiresAt &lt; Date.now()) {
+       // Check if token is expired (handle Firestore timestamp types correctly)
+       const now = Date.now();
+       const expiresAt = typeof userData.spotifyTokens.expiresAt === 'number' 
+         ? userData.spotifyTokens.expiresAt 
+         : userData.spotifyTokens.expiresAt?.toMillis?.() || userData.spotifyTokens.expiresAt;
+       
+       if (expiresAt &amp;&amp; expiresAt &lt; now) {
          console.log('Token expired, attempting refresh...');
          try {
```

</details>

</tool-use>

---



---

Checking for linting errors:


---

<tool-use data-tool-type="generic" data-tool-name="read_lints">
<details>
          <summary>Tool use: **read_lints** • Read lints for 2 files</summary>
      
Lint paths:

- `src/composables/useUserSpotifyApi.js`
- `functions/src/spotify.js`

Lint results


**No lint errors found**
</details>
</tool-use>

---



---

Verifying the final implementation:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/composables/useUserSpotifyApi.js</summary>

</details>
</tool-use>

---



---

## Changes Made:

1. **Proactive token refresh in `makeUserRequest()`**: Calls `ensureTokenFresh()` before each API request to refresh tokens that expire within 10 minutes.

2. **Updated `ensureTokenFresh()`**: Handles Firestore timestamp types (number or Timestamp object) when checking expiration.

3. **Updated `getUserTokens()`**: Handles timestamp types correctly.

4. **Updated `checkConnectionStatus()`**: Handles timestamp types correctly.

5. **Backend refresh token response**: Updated the refresh endpoint to return the refresh token if Spotify provides one (Spotify may not always provide it, but we should capture it when they do).

The refresh token mechanism was present but not triggered proactively. `makeUserRequest()` now checks and refreshes tokens before they expire (within 10 minutes of expiration), preventing the 1-hour expiration during active use.

Tokens will be refreshed automatically when needed, without requiring manual reconnection.

---

