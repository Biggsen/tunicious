<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 57fc4519-a2d3-41cf-be2a-1d129d830449 (2025-11-19 12:09Z) -->

# Review firebase project separation spec (2025-11-19 12:09Z)

_**User (2025-11-18 15:11Z)**_

review the firebase project separation spec. do we have enough info?

---

_**Agent (model default, mode Ask)**_



---


Reviewing the Firebase project separation spec for completeness.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: tasks/firebase-project-separation-spec.md</summary>

</details>
</tool-use>

---



---


Checking the current implementation to assess the spec's completeness:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/firebase.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/composables/useUserData.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="file_search">
<details>
            <summary>Tool use: **file_search** • Searched codebase "env.js" • **0** results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/views/auth/LastFmCallbackView.vue</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: functions/src/lastfm.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: firebase.json</summary>

</details>
</tool-use>

---



---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "env\.js|getEnvironment" in "src" • 0 matches</summary>

Output mode: content


_No matches found_

</details>
</tool-use>

---





---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "lastFmSessionKey|lastFmAuthenticated" in "src" • 28 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `src\views\playlists\PlaylistSingle.vue` | `if (!userData.value?.lastFmSessionKey \|\| !userData.value?.lastFmUserName) return;` | L173 |
| `src\views\playlists\PlaylistSingle.vue` | `await loveTrack(track.name, track.artists[0].name, userData.value.lastFmSessionKey);` | L189 |
| `src\views\playlists\PlaylistSingle.vue` | `if (!userData.value?.lastFmSessionKey \|\| !userData.value?.lastFmUserName) return;` | L221 |
| `src\views\playlists\PlaylistSingle.vue` | `await unloveTrack(track.name, track.artists[0].name, userData.value.lastFmSessionKey);` | L236 |
| `src\views\playlists\PlaylistSingle.vue` | `:lastFmSessionKey="userData?.lastFmSessionKey \|\| ''"` | L2156 |
| `src\views\playlists\PlaylistSingle.vue` | `:allowTrackLoving="userData?.lastFmAuthenticated \|\| false"` | L2157 |
| `src\components\AlbumItem.vue` | `lastFmSessionKey: \{` | L89 |
| `src\components\AlbumItem.vue` | `:sessionKey="lastFmSessionKey"` | L283 |
| `src\composables\useUserData.js` | `lastFmSessionKey: null,` | L88 |
| `src\composables\useUserData.js` | `lastFmAuthenticated: false,` | L89 |
| `src\views\auth\LastFmCallbackView.vue` | `lastFmSessionKey: sessionKey,` | L43 |
| `src\views\auth\LastFmCallbackView.vue` | `lastFmAuthenticated: true,` | L44 |
| `src\views\auth\AccountView.vue` | `<div v-if="!userData.lastFmAuthenticated && userData.lastFmUserName" class="mt-4">` | L123 |
| `src\components\LastFmDiagnostics.vue` | `userData?.lastFmAuthenticated ? 'bg-green-500' : 'bg-red-500'` | L20 |
| `src\components\LastFmDiagnostics.vue` | `\{{ userData?.lastFmAuthenticated ? 'Connected' : 'Not Connected' \}}` | L24 |
| `src\components\LastFmDiagnostics.vue` | `\{{ userData?.lastFmSessionKey ? `$\{userData.lastFmSessionKey.substring(0, 8)\}...` : 'Not Available' \}}` | L39 |
| `src\components\LastFmDiagnostics.vue` | `userData?.lastFmAuthenticated ? 'bg-green-500' : 'bg-gray-400'` | L49 |
| `src\components\LastFmDiagnostics.vue` | `\{{ userData?.lastFmAuthenticated ? 'Enabled' : 'Disabled' \}}` | L53 |
| `src\components\LastFmDiagnostics.vue` | `:disabled="tests.trackLoving.loading \|\| !userData?.lastFmAuthenticated"` | L104 |
| `src\components\LastFmDiagnostics.vue` | `:disabled="tests.sessionValidation.loading \|\| !userData?.lastFmSessionKey"` | L152 |
| `src\components\LastFmDiagnostics.vue` | `v-if="userData?.lastFmAuthenticated"` | L218 |
| `src\components\LastFmDiagnostics.vue` | `if (!userData.value?.lastFmAuthenticated) return` | L286 |
| `src\components\LastFmDiagnostics.vue` | `const result = await loveTrack('Bohemian Rhapsody', 'Queen', userData.value.lastFmSessionKey)` | L293 |
| `src\components\LastFmDiagnostics.vue` | `if (!userData.value?.lastFmSessionKey) return` | L335 |
| `src\components\LastFmDiagnostics.vue` | `const result = await validateSession(userData.value.lastFmSessionKey)` | L341 |
| `src\components\LastFmDiagnostics.vue` | `if (userData.value?.lastFmAuthenticated) \{` | L365 |
| `src\components\LastFmDiagnostics.vue` | `if (test.key === 'trackLoving' && !userData.value?.lastFmAuthenticated) continue` | L373 |
| `src\components\LastFmDiagnostics.vue` | `if (test.key === 'sessionValidation' && !userData.value?.lastFmSessionKey) continue` | L374 |


</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "How is environment detection currently implemented in the codebase?" • **14** results</summary>
            
| File | Lines |
|------|-------|
| `functions/src/lastfm.js` | L16-187 |
| `tasks/firebase-project-separation-spec.md` | L43 |
| `tasks/firebase-project-separation-spec.md` | L86-141 |
| `functions/src/lastfm.js` | L24 |
| `LASTFM_SETUP.md` | L50 |
| `tasks/firebase-project-separation-spec.md` | L40-89 |
| `src/composables/useSpotifyPlayer.js` | L19-657 |
| `src/main.js` | L49 |
| `src/firebase.js` | L19 |
| `.github/workflows/firebase-hosting-merge.yml` | L39 |
| `tasks/firebase-project-separation-spec.md` | L139-221 |
| `src/constants.js` | L15 |
| `.github/workflows/firebase-hosting-pull-request.yml` | L30 |
| `tasks/completed/security-remediation-spec.md` | L54 |

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: package.json</summary>

</details>
</tool-use>

---



---

<tool-use data-tool-type="generic" data-tool-name="glob_file_search">
<details>
<summary>Tool use: **glob_file_search** • Searched codebase "**/.github/workflows/*.yml" • **0** result in **1** directory</summary>

Directory: **c:\Users\biggs\webdev\audiofoodiev2** (0 file)

</details>
</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: functions/package.json</summary>

</details>
</tool-use>

---



---





---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "Where are GitHub Actions workflows configured for deployment?" • **14** results</summary>
            
| File | Lines |
|------|-------|
| `.github/workflows/firebase-hosting-merge.yml` | L39 |
| `.github/workflows/firebase-hosting-pull-request.yml` | L30 |
| `tasks/firebase-project-separation-spec.md` | L86-141 |
| `tasks/firebase-project-separation-spec.md` | L139-221 |
| `firebase.json` | L57 |
| `package.json` | L41 |
| `functions/package.json` | L26 |
| `.cursor/rules/development.mdc` | L57-134 |
| `.gitignore` | L29 |
| `.firebaserc` | L5 |
| `tasks/firebase-project-separation-spec.md` | L43 |
| `tasks/completed/security-remediation-spec.md` | L54 |
| `tasks/commercialization-roadmap.md` | L57 |
| `.cursor/rules/development.mdc` | L129-149 |

</details>
</tool-use>

---

<tool-use data-tool-type="generic" data-tool-name="list_dir">
<details>
            <summary>Tool use: **list_dir** • Listed directory undefined • **0** results</summary>
        
No results found
</details>
</tool-use>

---



---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: .firebaserc</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: .github/workflows/firebase-hosting-merge.yml</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: .github/workflows/firebase-hosting-pull-request.yml</summary>

</details>
</tool-use>

---



---


## Review of Firebase Project Separation Spec

The spec is mostly complete, but several gaps need to be addressed:

### Issues found

1. Current state is inaccurate
   - The spec says nested objects like `lastFmSessionKeys: { dev: '...', prod: '...' }` exist, but the codebase already uses flat `lastFmSessionKey` and `lastFmAuthenticated`.
   - The spec mentions `src/utils/env.js` to delete, but it doesn't exist.

2. Missing environment detection mechanism
   - The spec doesn't specify how to choose dev vs prod at runtime.
   - Add: use Vite's `import.meta.env.MODE` or `import.meta.env.DEV`/`import.meta.env.PROD` to select config.

3. Firebase project aliases setup
   - Missing steps for configuring `.firebaserc` with aliases.
   - Add: how to set up `dev` and `prod` aliases.

4. Service account handling
   - The repo includes `service-account.json`. The spec should clarify:
     - Whether to use separate service accounts per project
     - How to handle local development (dev project vs emulators)
     - Whether to keep this file in the repo or use environment variables

5. Spotify configuration
   - The spec doesn't address whether Spotify credentials need environment separation.
   - Current workflows use `VITE_SPOTIFY_CLIENT_ID` (shared). Clarify if `SPOTIFY_CLIENT_SECRET` in functions needs separation.

6. Firestore rules and indexes
   - Missing guidance on whether rules/indexes are shared or differ between projects.

7. GitHub Secrets management
   - The spec lists required secrets but doesn't detail:
     - Exact secret names to add
     - How to handle the transition (when to add dev secrets)
     - Whether to keep existing prod secrets or rename them

8. Local development workflow
   - Missing guidance on:
     - Whether devs should use the dev Firebase project or emulators
     - How to switch between environments locally
     - Whether `.env.local` should override environment detection

9. Functions deployment specifics
   - The spec mentions removing environment detection but doesn't show:
     - The exact code changes needed in `functions/src/lastfm.js`
     - How to handle secrets during deployment (which secrets to bind per project)
     - Whether `functions/src/spotify.js` also needs changes

10. Migration strategy
    - Missing details on:
      - How to identify "dev-specific data" to migrate
      - Whether to migrate all data or start fresh in dev
      - Timeline for the migration

### Recommendations

1. Add a section on environment detection:
   ```javascript
   // In src/firebase.js
   const isDev = import.meta.env.DEV || import.meta.env.MODE === 'development';
   ```

2. Add Firebase CLI setup steps:
   - How to create aliases: `firebase use --add`
   - Update `.firebaserc` structure

3. Clarify the current state:
   - Update Phase 3 since the data structure is already flat
   - Remove references to non-existent `env.js`

4. Add a "Local Development" section:
   - When to use emulators vs dev project
   - How to configure `.env.local`

5. Add a "Data Migration" section:
   - Criteria for what to migrate
   - Scripts or steps for migration

6. Specify exact GitHub Secrets names:
   - List all required secrets with exact naming
   - Include both dev and prod variants

7. Add a "Rollback Procedure" section:
   - Specific steps to revert if issues occur

The spec provides a solid foundation but needs these details to be actionable. Should I draft additions for any of these sections?

---

_**User (2025-11-18 15:11Z)**_

ok, I've switched to a different branch. eavluate again against it.

---

_**Agent (model default, mode Ask)**_



---


Re-evaluating the spec against the current branch. Checking key files for differences.


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/firebase.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/composables/useUserData.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: functions/src/lastfm.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="file_search">
<details>
            <summary>Tool use: **file_search** • Searched codebase "env.js" • **0** results</summary>
        
No results found
</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "lastFmSessionKeys|lastFmAuthenticated.*dev|lastFmAuthenticated.*prod" in "src" • 0 matches</summary>

Output mode: content


_No matches found_

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="grep">
<details>
<summary>Tool use: **grep** • Grep for "getEnvironment|isDevelopment|isDev|env\.MODE|env\.DEV|env\.PROD" in "src" • 3 matches</summary>

Output mode: content


| File | Content | Line |
|------|------|------|
| `src\main.js` | `if (import.meta.env.DEV) \{` | L28 |
| `src\constants.js` | `API_KEY: import.meta.env.PROD` | L7 |
| `src\constants.js` | `REDIRECT_URI: import.meta.env.PROD` | L19 |


</details>
</tool-use>

---



---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/main.js</summary>

</details>
</tool-use>

---





---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/constants.js</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/views/auth/LastFmCallbackView.vue</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "Where are nested environment objects like lastFmSessionKeys with dev and prod properties stored?" • **15** results</summary>
            
| File | Lines |
|------|-------|
| `tasks/firebase-project-separation-spec.md` | L40-89 |
| `tasks/firebase-project-separation-spec.md` | L43 |
| `functions/src/lastfm.js` | L16-187 |
| `src/constants.js` | L15 |
| `src/views/auth/LastFmCallbackView.vue` | L63 |
| `tasks/firebase-project-separation-spec.md` | L139-221 |
| `tasks/firebase-project-separation-spec.md` | L86-141 |
| `src/composables/useUserData.js` | L5-108 |
| `functions/src/lastfm.js` | L24 |
| `LASTFM_SETUP.md` | L50 |
| `tasks/firebase-project-separation-spec.md` | L215-251 |
| `src/views/auth/AccountView.vue` | L54 |
| `.github/workflows/firebase-hosting-merge.yml` | L39 |
| `src/firebase.js` | L19 |
| `docs/logging.md` | L48 |

</details>
</tool-use>

---



---


Re-evaluating the spec against this branch. Findings:

## Updated evaluation

### What's already correct in the spec
1. Functions environment detection — `functions/src/lastfm.js` still uses `isDevelopmentRequest()` and needs to be simplified.
2. Environment variables — `src/constants.js` already uses `import.meta.env.PROD` and `import.meta.env.DEV` for Last.fm API keys.

### Issues found on this branch

1. Current state is still inaccurate
   - The spec says nested objects like `lastFmSessionKeys: { dev: '...', prod: '...' }` exist, but the codebase already uses flat `lastFmSessionKey` and `lastFmAuthenticated`.
   - Phase 3 is mostly already done — data structures are already simplified.

2. Environment detection already exists
   - `src/constants.js` already uses `import.meta.env.PROD` and `import.meta.env.DEV`.
   - The spec should reference this pattern for `src/firebase.js`.

3. Missing details for `src/firebase.js` update
   - The spec says to update it but doesn't show the exact pattern. It should mirror `src/constants.js`:
   ```javascript
   const isDev = import.meta.env.DEV || import.meta.env.MODE === 'development';
   const firebaseConfig = isDev ? { /* dev config */ } : { /* prod config */ };
   ```

4. Phase 3 needs revision
   - Since data structures are already flat, Phase 3 should focus on:
     - Verifying all components use direct properties (already done)
     - Removing any remaining environment detection in user data logic (if any)
     - Updating the spec to reflect that this is already complete

5. Spotify redirect URI handling
   - `src/constants.js` already has environment-based redirect URIs. The spec should mention this pattern and whether it needs changes.

6. Functions secrets deployment
   - The spec doesn't specify how to deploy functions with only the relevant secrets per project. It should clarify:
     - Dev functions should only bind `LASTFM_API_KEY_DEV` and `LASTFM_API_SECRET_DEV`
     - Prod functions should only bind `LASTFM_API_KEY_PROD` and `LASTFM_API_SECRET_PROD`
     - How to configure this in `firebase.json` or deployment commands

### Additional missing information

1. `.firebaserc` update steps
   - Add explicit steps for setting up aliases:
   ```bash
   firebase use --add  # Add dev project
   firebase use --add  # Add prod project (or keep default)
   ```

2. Local development workflow
   - Clarify whether developers should:
     - Use the dev Firebase project when running `npm run dev`
     - Or continue using emulators
   - How `.env.local` should be configured

3. GitHub Actions workflow updates
   - The current workflows use `VITE_LASTFM_API_KEY_PROD` in both merge and PR workflows.
   - The spec should specify:
     - PR workflow should use DEV variables
     - Merge workflow should use PROD variables
     - Exact secret names to add to GitHub Secrets

4. Migration strategy
   - Since data structures are already flat, clarify:
     - Whether existing users in production need any migration
     - How to handle users who might have nested structures (if any exist)

### Recommendations

1. Update "Current State" section:
   - Remove references to nested objects
   - Note that data structures are already simplified
   - Focus on the remaining environment detection in functions

2. Update Phase 2:
   - Show exact code pattern for `src/firebase.js` based on `src/constants.js` pattern
   - Reference existing environment detection pattern

3. Revise Phase 3:
   - Mark as "mostly complete" or "verification needed"
   - Focus on removing functions environment detection instead

4. Add explicit deployment commands:
   - Show how to deploy functions with project-specific secrets
   - Include Firebase CLI commands for switching projects

5. Add GitHub Secrets checklist:
   - List all required secrets with exact names
   - Specify which workflow uses which secrets

The spec is close, but needs updates to reflect the current branch state and add the missing implementation details.

---

