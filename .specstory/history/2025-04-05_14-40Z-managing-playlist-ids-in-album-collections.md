<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 1f063b39-e256-4fdc-9d54-bda7aa74b1cc (2025-04-05 14:40Z) -->

# Managing Playlist IDs in Album Collections (2025-04-05 14:40Z)

_**User (2025-04-05 14:41Z)**_

I don't want to pass the playlist id as a querystring for the mapped albums. only for the albums founds within the albums collection.

---

_**Agent (mode Agent)**_

I'll help you understand the current implementation and suggest a solution for handling playlist IDs differently for mapped albums versus albums found directly in the collection.

Let me first examine the relevant code to understand how playlist IDs are currently being handled.


---

<tool-use data-tool-type="search" data-tool-name="codebase_search">
<details>
                <summary>Tool use: **codebase_search** • Searched codebase "playlist id querystring mapped albums" • **25** results</summary>
            
| File | Lines |
|------|-------|
| `src/views/ArtistView.vue` | L53-98 |
| `src/views/AlbumView.vue` | L1-57 |
| `src/composables/useAlbumsData.js` | L92-158 |
| `src/composables/useAlbumsData.js` | L1-30 |
| `src/views/PlaylistSingle.vue` | L59-106 |
| `src/utils/api.js` | L65-99 |
| `src/views/PlaylistSingle.vue` | L1-59 |
| `src/views/ArtistView.vue` | L1-53 |
| `src/composables/useAlbumsData.js` | L30-92 |
| `src/views/AlbumView.vue` | L243-316 |
| `src/components/AlbumItem.vue` | L1-67 |
| `src/utils/api.js` | L99-112 |
| `firestore.rules` | L1-43 |
| `src/views/AlbumView.vue` | L345-379 |
| `src/views/ArtistView.vue` | L223-293 |
| `src/views/ArtistView.vue` | L98-168 |
| `src/views/AlbumView.vue` | L115-172 |
| `src/composables/useAlbumsData.js` | L158-169 |
| `src/composables/useAlbumMappings.js` | L1-66 |
| `src/utils/api.js` | L127-143 |
| `src/views/AlbumView.vue` | L316-345 |
| `src/views/PlaylistSingle.vue` | L201-232 |
| `src/utils/api.js` | L46-65 |
| `src/views/PlaylistSingle.vue` | L232-297 |
| `src/views/AlbumView.vue` | L172-243 |

</details>
</tool-use>

---

Let me check the AlbumItem component to understand how playlist IDs are currently being passed:


---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/components/AlbumItem.vue</summary>

</details>
</tool-use>

---

Now let me check how the playlist status is determined in the ArtistView component:



---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/views/ArtistView.vue</summary>

</details>
</tool-use>

---

Let me also check how the AlbumItem component is used in the ArtistView:



---

<tool-use data-tool-type="read" data-tool-name="read_file">
<details><summary>Tool use: **read_file** • Read file: src/views/ArtistView.vue</summary>

</details>
</tool-use>

---

Based on my analysis, I understand the issue. Currently, the playlist ID is being passed as a query parameter for all albums, including those that are mapped. You want to only pass the playlist ID as a query parameter for albums found directly in the albums collection, not for mapped albums.

Here's what's happening:

1. In `ArtistView.vue`, the `checkPlaylistStatus` function determines if an album is in a playlist by:
   - First checking if it exists directly in the albums collection
   - If not, checking if it's an alternate ID that maps to a primary ID

2. The `AlbumItem` component receives a `currentPlaylist` prop which contains the playlist information, and it uses this to add a `playlistId` query parameter when navigating to the album page.

3. The issue is that for mapped albums, you still want to show that they're in a playlist (via the `playlistStatus` value), but you don't want to pass the playlist ID as a query parameter.

Let me propose a solution:

1. We need to modify the `AlbumItem` component to only include the playlist ID in the query parameters if the album is not a mapped album.

2. We need to add a new prop to the `AlbumItem` component to indicate whether the album is a mapped album.

Here's how we can implement this:

1. First, let's modify the `AlbumItem.vue` component to add a new prop and update the navigation logic:


---

<tool-use data-tool-type="write" data-tool-name="edit_file">

<details><summary>Tool use: **edit_file** • Edit file: src/components/AlbumItem.vue</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -9,4 +9,5 @@
    hideArtist: Boolean,
    currentPlaylist: Object,
+   isMappedAlbum: Boolean,
  });
  
```

**Chunk 2**
Lines added: 1, lines removed: 1

```diff
@@ -40,5 +41,5 @@
            name: 'album', 
            params: { id: album.id },
-           query: currentPlaylist ? { playlistId: currentPlaylist.playlistId } : undefined 
+           query: currentPlaylist &amp;&amp; !isMappedAlbum ? { playlistId: currentPlaylist.playlistId } : undefined 
          })"
        &gt;
```

</details>

</tool-use>

---

2. Now, let's update the `ArtistView.vue` component to track which albums are mapped and pass this information to the `AlbumItem` component:



---

<tool-use data-tool-type="write" data-tool-name="edit_file">

<details><summary>Tool use: **edit_file** • Edit file: src/views/ArtistView.vue</summary>

**Chunk 1**
Lines added: 2, lines removed: undefined

```diff
@@ -28,4 +28,6 @@
  // Track which albums are in playlists
  const playlistStatus = ref({});
+ // Track which albums are mapped
+ const mappedAlbums = ref({});
  
  const totalAlbums = computed(() =&gt; albumData.value.length);
```

**Chunk 2**
Lines added: 1, lines removed: undefined

```diff
@@ -59,4 +61,5 @@
      console.log(&#96;Album ${albumId} found directly in albums collection with current playlist&#96;);
      playlistStatus.value[albumId] = true;
+     mappedAlbums.value[albumId] = false;
      return;
    }
```

**Chunk 3**
Lines added: 1, lines removed: undefined

```diff
@@ -67,4 +70,5 @@
    console.log(&#96;Album ${albumId} mapping result:&#96;, primaryId);
    playlistStatus.value[albumId] = primaryId !== null;
+   mappedAlbums.value[albumId] = primaryId !== null;
    
    if (primaryId) {
```

**Chunk 4**
Lines added: 1, lines removed: undefined

```diff
@@ -233,4 +237,5 @@
            :hideArtist="true"
            :currentPlaylist="albumsStatus[album.id]?.playlistHistory?.find(h =&gt; !h.removedAt)"
+           :isMappedAlbum="mappedAlbums[album.id]"
            :class="{ 'not-in-playlist': !playlistStatus[album.id] }"
          /&gt;
```

</details>

</tool-use>

---

3. Now, let's also update the `PlaylistSingle.vue` component to handle this new prop:




---

<tool-use data-tool-type="write" data-tool-name="edit_file">

<details><summary>Tool use: **edit_file** • Edit file: src/views/PlaylistSingle.vue</summary>

**Chunk 1**
Lines added: 1, lines removed: undefined

```diff
@@ -228,4 +228,5 @@
            :lastFmUserName="userData?.lastFmUserName"
            :currentPlaylist="{ playlistId: id }"
+           :isMappedAlbum="false"
          /&gt;
        &lt;/ul&gt;
```

</details>

</tool-use>

---

With these changes, we've implemented the following solution:

1. Added a new `isMappedAlbum` prop to the `AlbumItem` component to indicate whether an album is a mapped album.

2. Modified the navigation logic in the `AlbumItem` component to only include the `playlistId` in the query parameters if the album is not a mapped album.

3. Updated the `ArtistView` component to track which albums are mapped and pass this information to the `AlbumItem` component.

4. Updated the `PlaylistSingle` component to pass `isMappedAlbum` as `false` since all albums in a playlist view are direct albums, not mapped ones.

This solution ensures that:
- Albums found directly in the albums collection will have the playlist ID passed as a query parameter
- Mapped albums will not have the playlist ID passed as a query parameter
- The UI will still show that mapped albums are in a playlist (via the `playlistStatus` value)

The changes maintain the existing functionality while addressing your specific requirement to not pass the playlist ID as a query parameter for mapped albums.

---

_**User (2025-04-05 14:44Z)**_

it's still passing the querystring. '/album/55mbc2X8vVi0wl7y9QdRzA?playlistId=2YuK0rgxUgVquocFMeeVXF' this id is an alternativeId, so should not pass the playlist id.

---

_**Agent (mode Agent)**_

I see the issue. The current implementation isn't correctly identifying mapped albums in the ArtistView component. Let's fix this by examining how we're determining if an album is mapped.

Looking at the code, I can see that we're setting `mappedAlbums.value[albumId] = true` when we find a mapping, but we're not correctly identifying when an album is a mapped album versus when it's a primary album.

Let's modify the `checkPlaylistStatus` function in ArtistView.vue to properly identify mapped albums:


---

<tool-use data-tool-type="write" data-tool-name="edit_file">

<details><summary>Tool use: **edit_file** • Edit file: src/views/ArtistView.vue</summary>

**Chunk 1**
Lines added: 13, lines removed: 2

```diff
@@ -56,10 +56,21 @@
    console.log(&#96;Checking playlist status for album ${albumId}&#96;);
    
-   // First check direct album status
+   // First check if this is a mapped album (alternateId)
+   const isMappedAlbum = await isAlternateId(albumId);
+   mappedAlbums.value[albumId] = isMappedAlbum;
+   
+   if (isMappedAlbum) {
+     console.log(&#96;Album ${albumId} is an alternateId (mapped album)&#96;);
+     // For mapped albums, we still want to show they're in a playlist if they map to a primary ID
+     const primaryId = await getPrimaryId(albumId);
+     playlistStatus.value[albumId] = primaryId !== null;
+     return;
+   }
+   
+   // For non-mapped albums, check direct album status
    const albumStatus = albumsStatus.value[albumId];
    if (albumStatus?.playlistHistory?.find(h =&gt; !h.removedAt)) {
      console.log(&#96;Album ${albumId} found directly in albums collection with current playlist&#96;);
      playlistStatus.value[albumId] = true;
-     mappedAlbums.value[albumId] = false;
      return;
    }
```

**Chunk 2**
Lines added: undefined, lines removed: 1

```diff
@@ -70,5 +81,4 @@
    console.log(&#96;Album ${albumId} mapping result:&#96;, primaryId);
    playlistStatus.value[albumId] = primaryId !== null;
-   mappedAlbums.value[albumId] = primaryId !== null;
    
    if (primaryId) {
```

</details>

</tool-use>

---

Now we need to add the `isAlternateId` function to the `useAlbumMappings` composable:



---

<tool-use data-tool-type="write" data-tool-name="edit_file">

<details><summary>Tool use: **edit_file** • Edit file: src/composables/useAlbumMappings.js</summary>

**Chunk 1**
Lines added: 24, lines removed: undefined

```diff
@@ -6,4 +6,28 @@
    const loading = ref(false);
    const error = ref(null);
+ 
+   /**
+    * Checks if an album ID is an alternate ID in the mappings
+    * @param {string} albumId - The album ID to check
+    * @returns {Promise&lt;boolean&gt;} True if the ID is an alternate ID, false otherwise
+    */
+   const isAlternateId = async (albumId) =&gt; {
+     try {
+       loading.value = true;
+       error.value = null;
+ 
+       const mappingsRef = collection(db, 'albumMappings');
+       const q = query(mappingsRef, where('alternateId', '==', albumId));
+       const querySnapshot = await getDocs(q);
+ 
+       return !querySnapshot.empty;
+     } catch (e) {
+       console.error('Error checking if album is an alternate ID:', e);
+       error.value = 'Failed to check if album is an alternate ID';
+       return false;
+     } finally {
+       loading.value = false;
+     }
+   };
  
    /**
```

**Chunk 2**
Lines added: 2, lines removed: 1

```diff
@@ -104,5 +128,6 @@
      getPrimaryId,
      getAlternateIds,
-     createMapping
+     createMapping,
+     isAlternateId
    };
  } 
```

</details>

</tool-use>

---

Now we need to update the ArtistView.vue to import the isAlternateId function:




---

<tool-use data-tool-type="write" data-tool-name="edit_file">

<details><summary>Tool use: **edit_file** • Edit file: src/views/ArtistView.vue</summary>

**Chunk 1**
Lines added: 1, lines removed: 1

```diff
@@ -15,5 +15,5 @@
  const { userData } = useUserData();
  const { fetchAlbumsData, loading: albumsLoading } = useAlbumsData();
- const { getPrimaryId, loading: mappingsLoading } = useAlbumMappings();
+ const { getPrimaryId, isAlternateId, loading: mappingsLoading } = useAlbumMappings();
  
  const id = computed(() =&gt; route.params.id);
```

</details>

</tool-use>

---

With these changes, we've fixed the issue by:

1. Adding a new `isAlternateId` function to the `useAlbumMappings` composable that checks if an album ID is an alternate ID in the albumMappings collection.

2. Modifying the `checkPlaylistStatus` function in ArtistView.vue to:
   - First check if the album is a mapped album (alternateId)
   - If it is, set `mappedAlbums.value[albumId] = true` and return early
   - For non-mapped albums, continue with the existing logic

3. Updating the import statement in ArtistView.vue to include the new `isAlternateId` function.

This solution ensures that:
- Albums that are alternate IDs (mapped albums) will be correctly identified
- The `isMappedAlbum` prop will be set to `true` for these albums
- The playlist ID will not be passed as a query parameter for mapped albums

Now when you navigate to an album page for a mapped album like '/album/55mbc2X8vVi0wl7y9QdRzA', it will not include the playlist ID in the query parameters, even if the album is in a playlist.

---

